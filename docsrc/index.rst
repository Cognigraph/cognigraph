.. cognigraph documentation master file, created by
   sphinx-quickstart on Wed Mar  7 12:36:26 2018.
   You can adapt this file completely to your liking, but it should at least
   contain the root `toctree` directive.

Когниграф
=========
Когниграф -- это ПО для визуализации и обработки ЭЭГ-сигналов в реальном времени.

.. toctree::
   :maxdepth: 2
   :caption: Contents:

.. _README: https://github.com/Cognigraph/cognigraph/blob/master/README.md


Установка программы
===================

Инструкции по установке программы можно найти в `README`_


Начало работы с программой
==========================

Для запуска программы необходимо запустить из терминала команду

.. code-block:: bash

   cognigraph

Установка входных данных конвеера
----------------------------------

После запуска появится графическое окно, разделенное на несколько секций.

Слева находится редактор конвеера обработки, в который уже добавлены некоторые
узлы. Конвеер, загружаемый по умолчанию, решает обратную задачу методом
"бимформер" и отображает найденную активность на коре.


Редактор конвеера разделен на две секции -- вернюю и нижнюю.
В верхней части отображены все узлы, входящие в текущий пайплайн.
Если кликнуть на один из узлов конвеера в верхней части редактора,
в нижней части появятся его параметры.

Для начала работы с пайплайном первое, что необходимо сделать, -- это
указать источник входных данных.
Для этого необходимо кликнуть в верхней части редактора монтажа по узлу
под названием ``File Source Node``, после чего в появившихся настройках в нижней части
редактора необходимо либо выбрать файл со входными данными,
кликнув на клавишу ``Select Data...``, либо поменять режим узла-источника
на чтение из LSL-потока, кликнув по кнопке ``Source type`` и выбрав
``LSL stream`` и в открывшемся меню выбрав имя потока.

Инициализация конвеера
-----------------------
После установки источника входных данных пайплайн необходимо инициализировать,
кликнув по кнопке ``Initialize pipeline`` в верхней части главного окна программы.

Инициализация программы необходима для того, чтобы настроить узлы конвеера
под конкретный источник данных. Прежде всего это касается информации об именах
и количестве каналов в данных. При настройке узла ``Beamformer Node``
появится редактор установки прямой модели.

Установка прямой модели.
------------------------
В открывшемся редакторе установка прямой модели, адекватной поступившим на
вход данным, может быть произведена несколькими способами,
самый простой из которых --- выбрать прямую модель из доступных по умолчанию.

Выбор прямой модели и анатомии по умолчанию
"""""""""""""""""""""""""""""""""""""""""""
Доступные по умолчанию прямые модели вместе с соответствующими файлами анатомии
при первом запуске программы отстутствуют в структуре папок когниграфа.
Программа предложит скачать их из облака при первом запуске редактора прямой модели.
По окончании загрузки выбор прямой модели осуществляется 
при нажатых радио-кнопках ``Use available anatomy`` и ``Use available forward``
переключением трех параметров в секции ``Select montage and spacing`` редактора: 
``Select montage``, ``Select spacing`` и ``Select forward``.
Первый параметр отвечает за выбор монтажа ЭЭГ-электродов (расположение электродов на
голове испытуемого и их названия), второй --- за количество источников на коре, для которых
будет решаться обратная задача, и последний --- за выбор прямой модели среди доступных
когниграфу на данный момент прямых моделей с соответствующим монтажем и количеством
источников. В случае, если выбранный монтаж согласуется с именами каналов в данных,
кнопка ``Ok`` станет активной, и нажатие на нее установит прямую модель.

Расчет новой прямой модели
""""""""""""""""""""""""""
Второй способ установки прямой модели --- посчитать новую с нуля.
Для этого необходимо установить анатомию в самой левой секции редактора (``Anatomy``),
либо выбрав анатомию уже доступного испытуемого в поле ``Subject``, либо загрузив
новую анатомию, переключив радио-кнопку ``Import anatomy`` и выбрав соответствующую
папку при помощи кнопки ``Browse``.

После того как анатомия установлена, в секции редактора под названием ``Forward model``
необходимо переключиться на радио-кнопку ``Compute forward``.
Далее в разделе редактора ``Select montage and spacing``, необходимо установить
монтаж и количество источников для прямой модели, которую мы собираемся посчитать.
Согласованность выбранного монтажа с данными, как и в случае выбора прямой модели 
по умолчанию, определяет доступность кнопки ``Ok``.

При расчете новой прямой модели в секции редактора ``Select montage and spacing``
доступна загрузка монтажа из файла, а также опция редактрования выбранного монтажа.
Чтобы отредактировать выбранный или загруженный монтаж, необходимо установить
галочку ``Use custom montage`` и кликнуть по кнопке ``Edit``
(для работы с редактором см. `Редактор монтажа`_).

После установки монтажа и количества источников в самой правой части редактора,
которая называется ``Forward computation parameters``, можно добавить файл корегистрации
электродов с анатомией (при его наличии) а также уточнить значения проводимостей
для кожи головы, костей черепа и объема внутри черепной коробки (``Conductivities``).

В случае, если все параметры в порядке, кнопка ``Ok`` в правом нижнем углу редактора
станет активной. Нажатие на нее запустит расчет прямой модели.

Импорт новой прямой модели
"""""""""""""""""""""""""""
Помимо выбора из доступных прямых моделей и расчета новой можно также импортировать
уже имеющуюся прямую модель --- радио-кнопка ``Import forward`` в разделе
``Forward model``. В случае, если имена каналов в загруженной прямой модели
согласуются с именами каналов в данных, кнопка ``Ok`` станет активна.

Выбор анатомии при этом также необходимо произвести по аналогии с предыдущим разделом.



По окончании инициализации в случае ее успешного завершения станет активна
кнопка ``Start``, производящая запуск конвеера.



Построение конвеера
====================
Программа имеет модульную структуру -- 
ЭЭГ данные передаются в **конвеер** обработки, который пользователь может модифицировать,
добавляя или удаляя **узлы**. Каждый узел отвечает за определенный этап обработки сигнала.
При этом сигнал пропускается последовательно через все узлы конвеера, проходя стадии обработки,
и каждый следующий узел конвеера получает входной сигнал от предыдущего.

Добавление узла
---------------
Для добавления узла обработки в конвеер необходимо кликнуть
левой кнопкой мыши по узлу, к которому необходимо добавить новый узел, в верхней части
**редактора конвеера** и выбрать соответствующй узел во всплывающем меню
через ``Add node --> <Имя узла>``. Доступные дочерние узлы варьируются в зависимости
от выбранного родительского узла.

Удаление узла
-------------
Удаление возможно только для листовых узлов дерева конвеера.
Для удаления произвольного узла необхоимо сначала удалить все его дочерние узлы.
Удаление выполняется через правый клик по узлу в верхней части редактора конвеера
и нажатие на ``Remove node`` во всплывающем меню.

Сохранение и загрузка конвеера
------------------------------
Для сохранения собранного конвеера необходимо нажать
``File --> Save pipeline``.
Для загрузки сохраненного ранее конвеера --- ``File --> Load pipeline``.

Предобработка данных
====================
Для предобработки данных в программе реализованы процедуры
фильтрации и децимации сигнала, поиск плохих каналов и удаление
артефактов методом независимых компонент.

Для фильтрации сигнала в дерево конвеера небходимо добавить узел
``Linear Filter`` и выставить верхний и нижний пороги фильтрации.
Все дочерние узлы по отношению к узлу-фильтру будут получать на вход фильтрованный сигнал.

Поиск плохих каналов и децимация сигнала осуществляются узлом ``Preprocessing``.
Для поиска плохих каналов необходимо в настройках узла (нижняя часть редактора конвеера)
нажать на кнопку ``Find bad channels``. После этого узел будет собирать сигнал в буфер для анализа
в течение времени, котрое регулируется параметром ``Baseline duration``. На этапе сбора данных
сигнал проходит через узел ``Preprocessing`` без изменений.
По истечении времени сбора данных на основании выбросов
в собранных данных каналы помечаются как плохие
и исключаются из дальнейшей обработки. Сбросить плохие каналы можно кнопкой ``Reset bads``.

Децимация сигнала осуществляется выставлением параметра ``Downsample factor`` в значение больше
единицы. Выставление этого параметра в двойку означает, что в данных будет оставлен только каждый
второй временной срез, в тройку - что каждый третий и т.д.

Удаление артефактов методом независимых компонент (ICA) осуществляется
узлом ``ICA Rejection``. Этот узел может быть добавлен либо к узлу-источнику (``LSL Source Node`` 
либо ``File Source Node``) либо к узлу ``Preprocessing``.
После добавления этого узла и инициализации конвеера необходимо начать сбор данных
кнопкой ``Collect data`` в настройках узла. Сбор данных происходит в течение времени,
которое задается параметром ``ICA duration`` по аналогии с узлом ``Preprocessing``.
По окончании сбора данных узел произведет ICA-разложение собранных данных и откроет
окно, в котором пользователю необходимо выбрать компоненты, которые он считает артефактными,
на основании их топографий, временных рядов и спектров. После выбора компонент необходимо нажать
кнопку ``Reject selection``. После закрытия окна выбора компонент выбранные компоненты будут удаляться из данных. Выбрать дополнительные компоненты на основании уже имеющегося ICA-разложения можно
кнопкой ``Select ICA components``. Чтобы очистить разложение на независимые компоненты,
необходимо нажать ``Reset ICA decomposition``.

Расчет источников
=================

Расчет источников в зависимости от желаемого метода осуществляется тремя узлами:
``Beamformer``, ``MNE`` и ``MCE``. 


Узел ``Beamformer`` осуществляет оценку источников методом LCMV и доступен в двух версиях:
адаптивной и неадаптивной. Переключение между версиями осуществляется галочкой ``Use adaptive version`` в настройках узла. Неадаптивная версия алгоритма использует всегда одну и ту же предустановленную матрицу ковариации данных, а адаптивная рассчитывает матрицу ковариации по вновь пришедшим данным
с "забыванием" (вновь пришедшие данные дают больший вклад в матрицу ковариации, чем старые).
Скорость забывания регулируется параметром ``Forgetting factor per second`` --- чем он больше,
тем быстрее происходит забывание. Также в настройках узла ``Beamformer`` доступна опция
изменения параметра регуляризации ``reg`` (чем он больше,
тем более размытое, но и стабильное получается решение), а также ``Output type``,
который регулирует тип выходного сигнала: ``power`` --- мощность, ``activation`` --- активация.
Галочка ``Prewhiten`` включает предварительное отбеливание данных,
что иногда приводит к более качественному решению за счет небольшого замедления работы узла.

Узел ``MNE`` реализует сразу три метода решения обратной задачи --- классический метод Minimum
Norm Estimate и его модификации dSPM и sLORETA.
Переключение между методами осуществляется при помощи переключателя ``Method``.

Узел ``MCE`` решает обратную задачу методом Minimum Current Estimate.

Визуализация источников и сигналов
==================================

Для визуализации временных рядов, получаемых на выходе узла, к узлу необходимо добавить
дочерний узел ``Signal Viewer``. 

Визуализация активности источников на коре реализована в узле ``Brain Viewer``.
Для более гладкой визуализации перед узлом ``Brain Viewer`` имеет смысл добавлять
узел ``Envelope Extractor``, который сглаживает сигнал по времени, извлекая его огибающую.
Параметр ``factor`` в его настройках управляет степенью сглаживания --- чем он больше, тем сильнее
сглаживание.
Настройки узла ``Brain Viewer`` позволяют управлять цветовой шкалой, а также пороговым значением,
ниже которого источники не отображаются. Кроме того, нажав на кнопку ``Record gif``,
можно записать текущую отображаемую активность в .gif формате. Вместе с .gif-файлом будет
сохранен файл с временными метками отображаемой в анимации активности.

Оценка и визуализация коннективности
====================================

Оценка коннективности в программе возможна в двух режимах: "все со всеми" и коннективность
с выбранным источником.

Для расчета коннективности в первом режиме к любому узлу, решающему обратную задачу,
необходимо сначала добавить узел ``Atlas Viewer``, и выбрать в нем при помощи кнопки
``Select ROI`` зоны, для которых будет измеряться коннективность.
Далее к узлу ``Atlas Viewer`` необходимо добавить узел ``Coherence``, который рассчитывает
когерентность между выбранными зонами, и наконец, для визуализации к узлу ``Coherence`` необходимо
добавить узел ``Connectivity Viewer``.
Этот узел  отображает ``number of connections`` самых сильных связей между выбранными
областями. Яркость линии кодирует силу связи.

Для расчета коннективности с выбранным источником к любому узлу, решающему обратную задачу,
необходимо добавить узел ``Seed Coherence``.
Выбор источника, с которым будет измеряться коннективность осуществляется кнопкой
``Select seed`` в настройках узла. Далее для визуализации необходимо добавить узел
``Brain Viewer``, либо сразу, либо после добавления ``Envelope Extractor``

Вывод активности в файл
=======================
Для вывода выходного сигнала любого узла к нему необходимо добавить
узел ``File Output``. Для выбора файла, в который будет производиться запись
необходимо нажать на кнопку ``Output path``. Для начала записи --- на кнопку
``Start``, для окончания -- ``Stop``. При повторном нажатии на ``Start`` файл будет перезаписан.
Выходной файл записывается в формате hdf5 при помощи пакета pytables.
Читать его рекомендуется при помощи той же библиотеки.

В файл записывается как сама активность, так и временные метки, а также имена каналов,
частота дискретизации и координаты источников в случае, если
среди потомков данного выходного узла есть узлы, решающие обратную задачу.

Редактор монтажа
================
Редактор монтажа позволяет переименовать каналы в выбранном монтаже, чтобы они соответствовали
именам каналов в данных.
Переименование необходимо в том числе для того, чтобы сопоставить электродам из данных
положения на голове испытуемого.

Редактор монтажа содержит два списка, кнопки для редакции имен каналов в прямой модели,
и виджет, отображающий положения электродов на голове испытуемого.
Именам электродов, взятым их данных, в редакторе монтажа соответствует левый список.
Правый список содержит имена, которые будут записаны во вновь созданный монтаж.
В случае, если имя из левого списка и имя из правого списка, соответствующие
одному и тому же порядковому номеру, совпадают, это имя в левом и правом списке
окрашиваются в зеленый цвет. При этом каналу из данных сопоставляется
положение (возможно перименованного) электрода из редактируемого монтажа.

Редактор монтажа позволяет успешно закончить редактирование (кнопка Ок становится активной)
в случае, если по крайней мере 20% всех каналов из данных сопоставлены с именами из редактируемого
монтажа.

Для редактирования имен каналов и их порядка предусмотрены следующие средства:

1) **Двойной клик по имени канала из правого списка**. Позволяет отредактировать
   имя одного канала.
2) **Drag and drop каналов из правого списка**. Позволяет передвинуть один или несколько каналов.
3) **Кнопки** ``Add prefix\Add suffix``. Одновременно для всех выделенных (или вообще для всех, если выделение отсутствует) каналов из правого списка позволяет добавить общую строку в начало или конец. Например, если в данных каналы названы по схеме "EEG TP9, EEG Fz, EEG Cz" и т.д., а в монтаже имеются каналы "TP9, Fz, Cz ...", кликнув на ``Add prefix`` и дописав "EEG " в появившейся строке ввода, можем добавить соответствующую открывающую строку ко всем именам каналов из редактируемого монтажа.
4) **Кнопки** ``Del prefix\Del suffix``. Позволяют удалить общую начальную или конечную строку для всех выделенных (или вообще для всех, если выделения нет) каналов из правого списка.
5) **Кнопка** ``Sort``. Сортирует каналы в правом списке.
6) **Кнопка** ``Align``. Автоматически ставит на нужные позиции каналы из редактируемого монтажа,
   если они есть в данных.
7) **Кнопка** ``>>``. По порядку присваивает каналам из правого списка имена из левого списка.
8) **Кнопка** ``Reset``. Возвращает каналы из правого списка к исходному состоянию.

.. Note:: Имена каналов из левого и правого списка в редакторе монтажа, как и во всей остальной
          программе, сравниваются в верхнем регистре, т.е. Tp9 и TP9 считается одним и тем же каналом
          и не нуждается в переименовании.
